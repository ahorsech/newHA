bolier:

    recorder:
      include:
        entities:
           - switch.bathroom_bolier
           - sensor.0x00158d00015751f4_power
           
    homeassistant:
      customize:
        
        switch.0x00158d00015751f4:
          friendly_name: Бойлер ванная, питание
          icon: mdi:power-plug
        sensor.0x00158d00015751f4_power:
          friendly_name: Бойлер ванная
          unit_of_measurement: Вт
          device_class: power


    binary_sensor:
    
      - platform: mqtt
        name: boiler
        state_topic: "states/water_heater"
        payload_on: "ON"
        payload_off: "OFF"
        
      - platform: tod
        name: boiler_morning
        after: '06:00'
        before: '07:00'
        
      - platform: tod
        name: boiler_evening
        after: '20:00'
        before: '21:00'  

    template:
     
      - binary_sensor:

    # Включение бойлера утром
          - name: boiler_morning_on
            state: >
              {{ is_state('binary_sensor.boiler', 'on')  
                 and is_state('binary_sensor.boiler_morning', 'on')}}
            icon: >
              {% if is_state("binary_sensor.boiler_morning_on", "on") %}
              mdi:sun-thermometer
              {% else %}
              mdi:sun-thermometer
              {% endif %}
              
          - name: boiler_evening_on
            state: >
              {{ is_state('binary_sensor.boiler', 'on')  
                 and is_state('binary_sensor.boiler_evening', 'on')}}
            icon: >
              {% if is_state("binary_sensor.boiler_evening_on", "on") %}
              mdi:sun-thermometer
              {% else %}
              mdi:sun-thermometer
              {% endif %}

    timer:

        heater:
          name: Бойлер выкл через -
          duration: '00:40:00'        
        
    switch:
    
      - platform: template
        switches:

          heater_mode:
            friendly_name: "Режим нагрева бойлера"
            value_template: "{{ is_state('binary_sensor.boiler', 'on') }}"
            turn_on:
              service: mqtt.publish
              data_template:
                topic: "states/water_heater"
                payload_template: 'ON'
                retain: true 
            turn_off:
              service: mqtt.publish
              data_template:
                topic: "states/water_heater"
                payload_template: 'OFF'
                retain: true 
            icon_template: >-
              {% if is_state('switch.heater_mode', 'on') %}
                mdi:water-boiler
              {% else %}
                mdi:water-boiler-off
              {% endif %}
              
          bathroom_bolier:
            friendly_name: "Бойлер"
            value_template: "{{ is_state('switch.0x00158d00015751f4', 'on') }}"
            turn_on:
              service: script.turn_on
              data:
                entity_id: script.bathroom_bolier_on
            turn_off:
              service: script.turn_on
              data:
                entity_id: script.bathroom_bolier_off
            icon_template: >-
              {% if is_state("switch.bathroom_bolier", "on") %}
              mdi:water-boiler
              {% else %}
              mdi:water-boiler-off
              {% endif %}
              
    automation:
    
      - id: Проверка корректности включения бойлера
        alias: boiler_impossible
        initial_state: true
        trigger:
         - platform: state
           entity_id: switch.bathroom_bolier
           to: 'on'
        condition:
         - condition: state
           entity_id: binary_sensor.boiler
           state: 'off'
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: switch.turn_off
           entity_id: switch.bathroom_bolier
         - service: telegram_bot.send_message
           data_template:
             target:
                 - !secret chat_id_group_tech
             message: | 
                  {{"\U0001F6AB"}} Включение бойлера невозможно, отключен режим нагрева воды. Время события - {{ states.sensor.time_date.state }}
                  
      - id: Включение бойлера
        alias: boiler_on
        initial_state: true
        trigger:    
         - platform: state
           entity_id: binary_sensor.boiler_morning_on
           from: 'off'
           to: 'on'
         - platform: state
           entity_id: binary_sensor.boiler_evening_on
           from: 'off'
           to: 'on'
        condition:
         - condition: state
           entity_id: switch.bathroom_bolier
           state: 'off'
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: switch.turn_on
           entity_id: switch.bathroom_bolier
           
      - id: Выключение бойлера
        alias: boiler_off
        initial_state: true
        trigger:    
         - platform: state
           entity_id: binary_sensor.boiler_morning_on
           from: 'on'
           to: 'off'
         - platform: state
           entity_id: binary_sensor.boiler_evening_on
           from: 'on'
           to: 'off'
         - platform: event
           event_type: timer.finished
           event_data:
             entity_id: timer.heater
        condition:
         - condition: state
           entity_id: switch.bathroom_bolier
           state: 'on'
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: switch.turn_off
           entity_id: switch.bathroom_bolier
           
      - id: Уведомление при включении бойлера
        alias: boiler_notify_on
        initial_state: true
        trigger:
         - platform: state
           entity_id: switch.bathroom_bolier
           to: 'on'
        condition:
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: telegram_bot.send_message
           data_template:
             target:
                 - !secret chat_id_group_tech
             message: | 
                  {{"\U00002714"}} Включение бойлера. Время события - {{ states.sensor.time_date.state }}
             
      - id: Уведомление при выключении бойлера
        alias: boiler_notify_off
        initial_state: true
        trigger:
         - platform: state
           entity_id: switch.bathroom_bolier
           to: 'off'
        condition:
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: telegram_bot.send_message
           data_template:
             target:
                 - !secret chat_id_group_tech
             message: | 
                  {{"\U00002716"}} Выключение бойлера. Время события - {{ states.sensor.time_date.state }}
                  
    script:
    
        bathroom_bolier_on:
          alias: Ванная бойлер включение
          sequence:
            - service: switch.turn_on
              entity_id: switch.0x00158d00015751f4
            - service: timer.start
              entity_id: timer.heater
              
        bathroom_bolier_off:
          alias: Ванная бойлер выключение
          sequence:
            - service: switch.turn_off
              entity_id: switch.0x00158d00015751f4
            - service: timer.cancel
              entity_id: timer.heater