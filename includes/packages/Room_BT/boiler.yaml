bolier:

    recorder:
      include:
        entities:
           - switch.0x00158d00015751f4
           - sensor.0x00158d00015751f4_power
           
    homeassistant:
      customize:
        
        switch.0x00158d00015751f4:
          friendly_name: Ванная бойлер
          icon: mdi:power-socket-eu
        sensor.0x00158d00015751f4_power:
          friendly_name: Ванная бойлер, мощность
          unit_of_measurement: Вт
          device_class: power
        sensor.0x00158d00015751f4_energy:
          friendly_name: Ванная бойлер, энергия
          icon: mdi:chart-line
        sensor.0x00158d00015751f4_device_temperature:
          friendly_name: Ванная бойлер, температура
          icon: mdi:thermometer-check
          
    input_datetime:
      bt_boiler_1:
        name: Бойлер ванная - 1 период
        has_date: false
        has_time: true
        
      bt_boiler_2:
        name: Бойлер ванная - 2 период
        has_date: false
        has_time: true

      bt_boiler_timer:
        name: Бойлер ванная - длительность работы
        has_date: false
        has_time: true

    binary_sensor:
    
      - platform: mqtt
        name: bt_boiler_mode
        state_topic: "states/water_heater"
        payload_on: "ON"
        payload_off: "OFF"
        
    timer:

        bt_boiler:
          name: Бойлер ванная - 
          restore: true
        
    switch:
    
      - platform: template
        switches:

          bt_boiler_mode:
            friendly_name: "Режим нагрева бойлера"
            value_template: "{{ is_state('binary_sensor.bt_boiler_mode', 'on') }}"
            turn_on:
              service: mqtt.publish
              data_template:
                topic: "states/water_heater"
                payload_template: 'ON'
                retain: true 
            turn_off:
              service: mqtt.publish
              data_template:
                topic: "states/water_heater"
                payload_template: 'OFF'
                retain: true 
            icon_template: >-
              {% if is_state('switch.bt_boiler_mode', 'on') %}
                mdi:water-boiler
              {% else %}
                mdi:water-boiler-off
              {% endif %}
              
    automation:
    
      - id: Проверка корректности включения бойлера ванная
        alias: bt_boiler_impossible
        initial_state: true
        trigger:
         - platform: state
           entity_id: switch.0x00158d00015751f4
           from: 'off'    
           to: 'on'
        condition:
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
            - choose:
    # Разрешенное включение
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.bt_boiler_mode
                    state: 'on'
                sequence:
                  - service: timer.start
                    entity_id: timer.bt_boiler
                    data_template: 
                        duration: >
                              {{strptime(states("input_datetime.bt_boiler_timer"), "%H:%M:%S").time()}}
                  - service: telegram_bot.send_message
                    data_template:
                      target:
                          - !secret chat_id_group_tech
                      message: | 
                          {{"\U00002714"}} Включение бойлера в ванной. Время события - {{ states.sensor.time_date.state }}
    # Случайное включение
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.bt_boiler_mode
                    state: 'off'
                sequence:
                  - service: switch.turn_off
                    entity_id: switch.0x00158d00015751f4
                  - service: telegram_bot.send_message
                    data_template:
                      target:
                         - !secret chat_id_group_tech
                      message: | 
                          {{"\U0001F6AB"}} Включение бойлера в ванной, отключен режим нагрева воды. Время события - {{ states.sensor.time_date.state }}

      - id: Включение бойлера в ванной
        alias: bt_boiler_on
        initial_state: true
        trigger:    
         - platform: time
           at: input_datetime.bt_boiler_1
         - platform: time
           at: input_datetime.bt_boiler_2
        condition:
         - condition: state
           entity_id: switch.0x00158d00015751f4
           state: 'off'
         - condition: state
           entity_id: binary_sensor.bt_boiler_mode
           state: 'on'
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: switch.turn_on
           entity_id: switch.0x00158d00015751f4
           
      - id: Выключение бойлера в ванной
        alias: bt_boiler_off
        initial_state: true
        trigger:    
         - platform: state
           entity_id: binary_sensor.bt_boiler_mode
           from: 'on'
           to: 'off'
         - platform: event
           event_type: timer.finished
           event_data:
             entity_id: timer.bt_boiler
        condition:
         - condition: state
           entity_id: switch.0x00158d00015751f4
           state: 'on'
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
        action:
         - service: switch.turn_off
           entity_id: switch.0x00158d00015751f4

      - id: Уведомление при выключении бойлера в ванной
        alias: bt_boiler_notify_off
        initial_state: true
        trigger:
         - platform: state
           entity_id: switch.0x00158d00015751f4
           from: 'on'
           to: 'off'
        condition:
         - condition: state
           entity_id: switch.control_mode
           state: 'on'
         - condition: state
           entity_id: binary_sensor.bt_boiler_mode
           state: 'on'
        action:
         - service: telegram_bot.send_message
           data_template:
             target:
                 - !secret chat_id_group_tech
             message: | 
                  {{"\U00002716"}} Выключение бойлера в ванной. Время события - {{ states.sensor.time_date.state }}