tt_light:

    homeassistant:
      customize:
      
        light.tt_ceiling_light:
          friendly_name: Туалет, люстра
        light.0xec1bbdfffea37571:
          friendly_name: Туалет, свет зеркала
          
        binary_sensor.0x00158d0001a24e71_occupancy:
          friendly_name: Туалет, датчик движения
        sensor.0x00158d0001a24e71_battery:
          friendly_name: Туалет, датчик движения
          
        switch.0x00158d00014dceb3_left:
          friendly_name: Туалет, питание люстры
        fan.0x00158d00014dceb3_right:
          friendly_name: Туалет, вытяжка
        sensor.0x00158d00014dceb3_action:
          friendly_name: Туалет, выключатель на входе
          
        sensor.0x54ef441000279090_action:
          friendly_name: Туалет, Aqara E1
        sensor.0x54ef441000279090_battery:
          friendly_name: Туалет, Aqara E1
          
    template:
     
      - binary_sensor:

    # Сенсор определяющий недоступность люстры 
          - name: tt_ceiling_unavailable
            state: >
              {{ is_state('light.tt_ceiling_light', 'unavailable')  
              }}
            delay_on: 
                minutes: 3
            device_class: problem
            icon: >
              {% if is_state("binary_sensor.tt_ceiling_unavailable", "on") %}
              mdi:ceiling-light-outline
              {% else %}
              mdi:ceiling-light
              {% endif %}

    # Свет без движения в туалете днем
          - name: tt_light_day
            state: >
              {{ is_state('light.tt_ceiling_light', 'on')  
                 and is_state('binary_sensor.0x00158d0001a24e71_occupancy', 'off')
                 and is_state('binary_sensor.tt_night', 'off')
              }}
            delay_on: 00:05:00
            icon: >
              {% if is_state("binary_sensor.tt_light_day", "on") %}
              mdi:timer
              {% else %}
              mdi:timer-off
              {% endif %}
              
    # Свет без движения в туалете ночью
          - name: tt_light_night
            state: >
              {{ is_state('light.tt_ceiling_light', 'on')  
                 and is_state('binary_sensor.0x00158d0001a24e71_occupancy', 'off')
                 and is_state('binary_sensor.tt_night', 'on')
              }}
            delay_on: 00:01:00
            icon: >
              {% if is_state("binary_sensor.tt_light_night", "on") %}
              mdi:timer
              {% else %}
              mdi:timer-off
              {% endif %}
              
    # Свет более 5 минут, условие для включения вентиляции
          - name: tt_fan_on
            state: >
              {{ is_state('light.tt_ceiling_light', 'on') 
                 and is_state('fan.0x00158d00014dceb3_right', 'off')
              }}
            delay_on: 00:05:00
            icon: >
              {% if is_state("binary_sensor.tt_fan_on", "on") %}
              mdi:timer
              {% else %}
              mdi:timer-off
              {% endif %}
              
    # Вентиляция более 10 минут, условие для выключения вентиляции
          - name: tt_fan_off
            state: >
              {{ is_state('fan.0x00158d00014dceb3_right', 'on')  
              }}
            delay_on: 00:10:00
            icon: >
              {% if is_state("binary_sensor.tt_fan_off", "on") %}
              mdi:timer
              {% else %}
              mdi:timer-off
              {% endif %}

    binary_sensor:
    
      - platform: tod
        name: tt_night
        after: '23:00'
        before: '07:00'

    automation:

      - id: Туалет, перезагрузка зависшей люстры 
        alias: tt_ceiling_reboot
        initial_state: true
        trigger:
    # Проверка раз в 5 минут, перезагрузка если люстра недоступна
        - platform: time_pattern
          minutes: '/5'
        condition:
    # Сенсор определяющий недоступность люстры
        - condition: state
          entity_id: binary_sensor.tt_ceiling_unavailable
          state: 'on'
    # Переключатель режима работы сервера
        - condition: state
          entity_id: switch.control_mode
          state: 'on'
        action:
    # Перезагрузка по питанию
        - service: switch.turn_off
          entity_id: switch.0x00158d00014dceb3_left
        - delay: 00:00:05
        - service: switch.turn_on
          entity_id: switch.0x00158d00014dceb3_left

      - id: Туалет, включение люстры
        alias: tt_light_on
        initial_state: true
        trigger:
    # Датчик движения 
        - platform: state
          entity_id: binary_sensor.0x00158d0001a24e71_occupancy
          to: 'on'
    # Выключатель на стене у входа
        - platform: state
          entity_id: sensor.0x00158d00014dceb3_action
          to: 'single_left'
    # Выключатель в туалете
        - platform: state
          entity_id: sensor.0x54ef441000279090_action
          to: 'single_left'
    # 4 клавишник на комоде
        - platform: state
          entity_id: sensor.0x04cf8cdf3c7942ca_action
          to: 'button_2_single' 
        condition:
    # Переключатель режима работы сервера
        - condition: state
          entity_id: switch.control_mode
          state: 'on'
    # Люстра выключена
        - condition: state
          entity_id: light.tt_ceiling_light
          state: 'off'
        action:          
            - choose:
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.tt_night
                    state: 'off'
                sequence:
                  - service: light.turn_on
                    entity_id:
                      - light.tt_ceiling_light
                    data_template:
                      brightness_pct: 100
                      kelvin: 4000
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.tt_night
                    state: 'on'
                sequence:
                  - service: light.turn_on
                    entity_id:
                      - light.tt_ceiling_light
                    data_template:
                      brightness_pct: 50
                      kelvin: 3500
    
      - id: Туалет, выключение люстры
        alias: tt_light_off
        initial_state: true
        trigger:
    # Выключатель на стене у входа
        - platform: state
          entity_id: sensor.0x00158d00014dceb3_action
          to: 'single_left'
    # Выключатель в туалете
        - platform: state
          entity_id: sensor.0x54ef441000279090_action
          to: 'single_left'
    # 4 клавишник на комоде
        - platform: state
          entity_id: sensor.0x04cf8cdf3c7942ca_action
          to: 'button_2_single' 
    # Выключение света без движения днем
        - platform: state
          entity_id: binary_sensor.tt_light_day
          to: 'on'
    # Выключение света без движения ночью
        - platform: state
          entity_id: binary_sensor.tt_light_night
          to: 'on'
        condition:
    # Переключатель режима работы сервера
        - condition: state
          entity_id: switch.control_mode
          state: 'on'
    # Люстра включена
        - condition: state
          entity_id: light.tt_ceiling_light
          state: 'on'
        action:
        - service: light.turn_off
          entity_id: light.tt_ceiling_light

    # Управление вентиляцией   
      - id: Туалет, управление вентилятором
        alias: tt_fan_control
        initial_state: true
        trigger:
    # Выключатель в туалете
        - platform: state
          entity_id: sensor.0x54ef441000279090_action
          to: 'single_right' 
    # Включение через 5 минут
        - platform: state
          entity_id: binary_sensor.tt_fan_on
          to: 'on'
    # Выключение через 10 минут
        - platform: state
          entity_id: binary_sensor.tt_fan_off
          to: 'on'
        condition:
        - condition: state
          entity_id: switch.control_mode
          state: 'on' 
        action:
            - choose:
              - conditions:
                  - condition: state
                    entity_id: fan.0x00158d00014dceb3_right
                    state: 'off'
                sequence:
                  - service: fan.turn_on
                    entity_id: fan.0x00158d00014dceb3_right
              - conditions:
                  - condition: state
                    entity_id: fan.0x00158d00014dceb3_right
                    state: 'on'
                sequence:
                  - service: fan.turn_off
                    entity_id: fan.0x00158d00014dceb3_right
                    
    # Управление подсветкой зеркала
      - id: Туалет, управление подсветкой зеркала
        alias: tt_mirror_control
        initial_state: true
        trigger:
    # Выключатель в туалете
        - platform: state
          entity_id: sensor.0x54ef441000279090_action
          to: 'single_both'
        condition:
        - condition: state
          entity_id: switch.control_mode
          state: 'on' 
        action:
        - service: light.toggle
          entity_id: light.0xec1bbdfffea37571